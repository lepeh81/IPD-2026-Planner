<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Strategic Planner (Cloud)</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Load PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Flashing Animation for Delayed Tasks */
        @keyframes flash-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: rgb(252, 165, 165); }
            50% { box-shadow: 0 0 8px 1px rgba(239, 68, 68, 0.4); border-color: rgb(239, 68, 68); background-color: #fef2f2; }
        }
        .animate-alert {
            animation: flash-red 2s infinite;
        }
        
        .no-print {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            ZoomIn, ZoomOut, Plus, Calendar as CalendarIcon, User, 
            CheckCircle, Clock, AlertCircle, X, Trash2, Search, 
            ChevronLeft, ChevronRight, Lock, Unlock, BarChart3, 
            Paperclip, FileText, LogOut, ShieldCheck, Eye, Download, Link,
            CheckSquare, Square, ArrowRight, ExternalLink, Flag, PlayCircle, Check, AlertTriangle, CalendarDays,
            Printer, FileDown, WifiOff, Wifi, Save, Database, Upload, FileJson, CloudOff, Info
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration & Init ---
        let app, auth, db;
        let configError = false;
        let isCloudConfigured = false;
        
        // Use a fixed App ID for consistency
        const appId = 'ipd-planner-v1';

        // ------------------------------------------------------------------
        // CONFIGURATION
        // ------------------------------------------------------------------
        const MANUAL_CONFIG = {
            apiKey: "AIzaSyBLZ_RhnVPveMDBFONL7pkqiu2xL21oETw",
            authDomain: "ipd-planner.firebaseapp.com",
            databaseURL: "https://ipd-planner-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ipd-planner",
            storageBucket: "ipd-planner.firebasestorage.app",
            messagingSenderId: "218355029597",
            appId: "1:218355029597:web:137b36b6ff10b071321fb4",
            measurementId: "G-NGSNKPYS7K"
        }; 

        try {
            // Priority: Manual Config > Env Config
            let configToUse = MANUAL_CONFIG;
            
            // Fallback to environment if manual is null (for development preview)
            if (!configToUse && typeof __firebase_config !== 'undefined') {
                configToUse = JSON.parse(__firebase_config);
            }

            if (configToUse) {
                app = initializeApp(configToUse);
                auth = getAuth(app);
                db = getFirestore(app);
                isCloudConfigured = true;
            } else {
                configError = true;
            }
        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            configError = true;
        }

        // --- Constants ---

        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const DAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        const MALAYSIA_HOLIDAYS_2026 = {
            "2026-01-01": "New Year's Day",
            "2026-02-01": "Thaipusam (Est)",
            "2026-02-17": "Chinese New Year",
            "2026-02-18": "Chinese New Year Day 2",
            "2026-03-20": "Hari Raya Aidilfitri (Est)",
            "2026-03-21": "Hari Raya Aidilfitri Day 2 (Est)",
            "2026-05-01": "Labour Day",
            "2026-05-27": "Hari Raya Aidiladha (Est)",
            "2026-05-31": "Wesak Day (Est)",
            "2026-06-01": "Agong's Birthday",
            "2026-06-16": "Awal Muharram (Est)",
            "2026-08-31": "Merdeka Day",
            "2026-09-16": "Malaysia Day",
            "2026-09-24": "Prophet Muhammad's Birthday (Est)",
            "2026-11-08": "Deepavali (Est)",
            "2026-12-25": "Christmas Day"
        };

        const PIC_COLORS = {
            "Hilmy": "bg-blue-100 text-blue-800 border-blue-300",
            "Nadiah": "bg-pink-100 text-pink-800 border-pink-300",
            "Hasbalah": "bg-emerald-100 text-emerald-800 border-emerald-300",
            "Asmawi": "bg-purple-100 text-purple-800 border-purple-300",
            "Farah Idayu": "bg-yellow-100 text-yellow-800 border-yellow-300",
            "Fateha": "bg-orange-100 text-orange-800 border-orange-300",
            "Admin": "bg-gray-100 text-gray-800 border-gray-300"
        };

        // --- Helper Functions ---
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const formatDateKey = (year, month, day) => `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const parseDate = (str) => {
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        const addDays = (dateStr, days) => {
            const d = parseDate(dateStr);
            d.setDate(d.getDate() + days);
            return formatDateKey(d.getFullYear(), d.getMonth(), d.getDate());
        };

        const getTodayKey = () => {
            const d = new Date();
            return formatDateKey(d.getFullYear(), d.getMonth(), d.getDate());
        };

        // --- Main Component ---
        function PlannerApp() {
            const [currentYear, setCurrentYear] = useState(2026);
            const [currentMonth, setCurrentMonth] = useState(0); 
            const [zoomLevel, setZoomLevel] = useState(1);
            
            // Auth States
            const [dbUser, setDbUser] = useState(null); // Firebase User
            const [isAdmin, setIsAdmin] = useState(false); // UI Admin Mode
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [authErrorMsg, setAuthErrorMsg] = useState(null); // Detailed auth error message

            // Data State
            const [tasks, setTasks] = useState([]);
            
            // UI State
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
            const [isTeamStatsOpen, setIsTeamStatsOpen] = useState(false);
            const [isDownloadModalOpen, setIsDownloadModalOpen] = useState(false);
            const [isDownloading, setIsDownloading] = useState(false);
            const [downloadStatus, setDownloadStatus] = useState('');
            
            const [selectedTask, setSelectedTask] = useState(null);
            const [selectedDate, setSelectedDate] = useState(null); 
            const [filterPic, setFilterPic] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');

            // --- Data Synchronization (Hybrid) ---

            const loadFromLocal = () => {
                const saved = localStorage.getItem('planner_2026_tasks');
                if (saved) {
                    setTasks(JSON.parse(saved));
                } else {
                    // Default Demo Data
                    setTasks([
                        {
                            id: "demo_1",
                            startDate: '2026-01-15',
                            endDate: '2026-01-15',
                            title: 'Q1 Strategy Meeting',
                            pic: ['Hilmy', 'Nadiah'], 
                            completedBy: ['Hilmy', 'Nadiah'], 
                            description: 'Discuss roadmap for 2026.',
                            attachments: [],
                            timestamp: new Date('2026-01-14T09:00:00').toISOString()
                        }
                    ]);
                }
            };

            const saveToLocal = (newTasks) => {
                setTasks(newTasks);
                localStorage.setItem('planner_2026_tasks', JSON.stringify(newTasks));
            };

            useEffect(() => {
                const initAuth = async () => {
                    // If no config, skip to local
                    if (!isCloudConfigured || !auth) {
                        setConnectionStatus('local');
                        loadFromLocal();
                        return;
                    }

                    try {
                        // Attempt Anonymous Auth
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.warn("Firebase Auth Error:", e.code);
                        setConnectionStatus('local'); // Fallback to local
                        loadFromLocal();
                        
                        if (e.code === 'auth/admin-restricted-operation' || e.code === 'auth/operation-not-allowed') {
                            setAuthErrorMsg("Cloud Sync Disabled: Please enable 'Anonymous' authentication in the Firebase Console.");
                        } else {
                            setAuthErrorMsg(`Cloud Sync Error: ${e.message}`);
                        }
                    }
                };

                initAuth();

                // Listen for auth state changes
                if (auth) {
                    const unsubscribe = onAuthStateChanged(auth, (u) => {
                        setDbUser(u);
                        if (u) {
                             setConnectionStatus('connected');
                             setAuthErrorMsg(null);
                        }
                    });
                    return () => unsubscribe();
                }
            }, []);

            // Firestore Listener
            useEffect(() => {
                if (!dbUser || !db) return;
                
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const loadedTasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setTasks(loadedTasks);
                }, (error) => {
                    console.error("Firestore sync error:", error);
                    // Fallback to local if permission denied or read error
                    setConnectionStatus('local');
                    loadFromLocal();
                });

                return () => unsubscribe();
            }, [dbUser]);

            // --- Status Logic ---
            const getTaskStatus = (task) => {
                const today = getTodayKey();
                const isFullyComplete = task.pic.every(p => task.completedBy.includes(p));
                
                if (isFullyComplete) return 'completed';
                if (today > task.endDate) return 'overdue';
                if (today < task.startDate) return 'future'; 
                return 'pending'; // Active / In Progress
            };

            // Computed
            const calendarDays = useMemo(() => {
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                const firstDay = getFirstDayOfMonth(currentYear, currentMonth);
                const days = [];
                const todayKey = getTodayKey();

                const overdueTasks = tasks.filter(t => {
                    const isFullyComplete = t.pic.every(p => t.completedBy.includes(p));
                    return t.endDate < todayKey && !isFullyComplete;
                });

                for (let i = 0; i < firstDay; i++) {
                    days.push({ type: 'empty', key: `empty-${i}` });
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = formatDateKey(currentYear, currentMonth, i);
                    
                    let dayTasks = tasks.filter(t => dateKey >= t.startDate && dateKey <= t.endDate);

                    if (dateKey === todayKey) {
                        const carried = overdueTasks.map(t => ({ ...t, isCarried: true }));
                        // De-dupe based on ID
                        const existingIds = new Set(dayTasks.map(t => t.id));
                        const uniqueCarried = carried.filter(c => !existingIds.has(c.id));
                        dayTasks = [...dayTasks, ...uniqueCarried];
                    }

                    days.push({
                        type: 'day',
                        day: i,
                        dateKey: dateKey,
                        holiday: MALAYSIA_HOLIDAYS_2026[dateKey],
                        tasks: dayTasks
                    });
                }
                return days;
            }, [currentYear, currentMonth, tasks]);

            const stats = useMemo(() => {
                const total = tasks.length;
                let completed = 0, future = 0, pending = 0, overdue = 0;
                
                tasks.forEach(t => {
                    const status = getTaskStatus(t);
                    if (status === 'completed') completed++;
                    else if (status === 'future') future++;
                    else if (status === 'overdue') overdue++;
                    else pending++; 
                });

                return { total, completed, future, pending, overdue };
            }, [tasks]);

            // Actions
            const handleZoom = (direction) => {
                setZoomLevel(prev => Math.min(Math.max(direction === 'in' ? prev + 0.1 : prev - 0.1, 0.5), 1.5));
            };

            const handleDayClick = (dateKey) => {
                if (!isAdmin) return;
                setSelectedDate(dateKey);
                setSelectedTask(null);
                setIsTaskModalOpen(true);
            };

            const handleTaskClick = (e, task, dateKey) => {
                e.stopPropagation();
                setSelectedTask(task);
                setSelectedDate(dateKey); 
                setIsTaskModalOpen(true);
            };

            const togglePicCompletion = async (e, task, picName) => {
                e.stopPropagation();
                if (!isAdmin) return;

                const currentCompleted = task.completedBy || [];
                let newCompleted;
                if (currentCompleted.includes(picName)) {
                    newCompleted = currentCompleted.filter(p => p !== picName);
                } else {
                    newCompleted = [...currentCompleted, picName];
                }
                
                if (connectionStatus === 'connected' && db) {
                     try {
                        const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', task.id);
                        await updateDoc(taskRef, { 
                            completedBy: newCompleted,
                            timestamp: new Date().toISOString()
                        });
                    } catch (err) {
                        console.error("Cloud update failed", err);
                        // Fallback local update if cloud fails momentarily
                        const updatedTasks = tasks.map(t => t.id === task.id ? { ...t, completedBy: newCompleted, timestamp: new Date().toISOString() } : t);
                        setTasks(updatedTasks);
                    }
                } else {
                    const updatedTasks = tasks.map(t => t.id === task.id ? { ...t, completedBy: newCompleted, timestamp: new Date().toISOString() } : t);
                    saveToLocal(updatedTasks);
                }
            };

            const saveTask = async (taskData) => {
                const { isCarried, id, ...cleanTask } = taskData;
                cleanTask.timestamp = new Date().toISOString();

                if (!cleanTask.completedBy) cleanTask.completedBy = [];
                if (cleanTask.endDate < cleanTask.startDate) cleanTask.endDate = cleanTask.startDate;

                try {
                    if (connectionStatus === 'connected' && db) {
                        if (selectedTask) {
                            const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id);
                            await updateDoc(taskRef, cleanTask);
                        } else {
                            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
                            await addDoc(colRef, cleanTask);
                        }
                    } else {
                        // Local Save
                        if (selectedTask) {
                            const updatedTasks = tasks.map(t => t.id === id ? { ...cleanTask, id } : t);
                            saveToLocal(updatedTasks);
                        } else {
                            const newTask = { ...cleanTask, id: Date.now().toString() };
                            saveToLocal([...tasks, newTask]);
                        }
                    }
                    setIsTaskModalOpen(false);
                } catch (e) {
                    console.error("Error saving task", e);
                    alert("Failed to save.");
                }
            };

            const deleteTask = async (id, mode) => {
                try {
                    // Logic calculation for what to delete/update/add
                    let actions = { type: 'none', deleteId: null, updateId: null, updateData: null, addData: null };
                    let localNewTasks = [...tasks];

                    if (mode === 'all' || !selectedDate) {
                        actions.type = 'delete';
                        actions.deleteId = id;
                        localNewTasks = localNewTasks.filter(t => t.id !== id);
                    } else {
                        const taskIndex = tasks.findIndex(t => t.id === id);
                        if (taskIndex === -1) return;
                        
                        const task = tasks[taskIndex];
                        const dateToDelete = selectedDate;

                        if (dateToDelete < task.startDate || dateToDelete > task.endDate) return; 
                        
                        if (task.startDate === task.endDate) {
                            actions.type = 'delete';
                            actions.deleteId = id;
                            localNewTasks = localNewTasks.filter(t => t.id !== id);
                        } else if (dateToDelete === task.startDate) {
                            const newStart = addDays(task.startDate, 1);
                            actions.type = 'update';
                            actions.updateId = id;
                            actions.updateData = { startDate: newStart };
                            localNewTasks[taskIndex] = { ...task, startDate: newStart };
                        } else if (dateToDelete === task.endDate) {
                            const newEnd = addDays(task.endDate, -1);
                            actions.type = 'update';
                            actions.updateId = id;
                            actions.updateData = { endDate: newEnd };
                            localNewTasks[taskIndex] = { ...task, endDate: newEnd };
                        } else {
                            const endA = addDays(dateToDelete, -1);
                            const startB = addDays(dateToDelete, 1);
                            
                            actions.type = 'split';
                            actions.updateId = id;
                            actions.updateData = { endDate: endA };
                            
                            const taskB = { ...task };
                            delete taskB.id; 
                            taskB.startDate = startB;
                            actions.addData = taskB;

                            const taskA = { ...task, endDate: endA };
                            const localTaskB = { ...task, id: Date.now().toString(), startDate: startB };
                            localNewTasks = [...localNewTasks.slice(0, taskIndex), taskA, localTaskB, ...localNewTasks.slice(taskIndex + 1)];
                        }
                    }

                    // Execute
                    if (connectionStatus === 'connected' && db) {
                        if (actions.deleteId) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', actions.deleteId));
                        if (actions.updateId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', actions.updateId), actions.updateData);
                        if (actions.addData) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), actions.addData);
                    } else {
                        saveToLocal(localNewTasks);
                    }

                    setIsTaskModalOpen(false);
                } catch (e) {
                    console.error("Delete failed", e);
                    alert("Failed to delete task.");
                }
            };

            const handleLogin = (username) => {
                setIsAdmin(true);
                setIsLoginModalOpen(false);
            };

            // PDF Generation
            const generatePDF = async (monthsToPrint) => {
                setIsDownloading(true);
                const element = document.getElementById('planner-board');
                if (!element) return;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [1600, 1000] }); 
                
                const originalMonth = currentMonth;
                const originalZoom = zoomLevel;
                setZoomLevel(1); 

                try {
                    for (let i = 0; i < monthsToPrint.length; i++) {
                        const mIndex = monthsToPrint[i];
                        setCurrentMonth(mIndex);
                        setDownloadStatus(`Rendering ${MONTHS[mIndex]}...`);
                        await new Promise(r => setTimeout(r, 600)); 

                        const canvas = await window.html2canvas(element, { scale: 1.5, useCORS: true, logging: false, windowWidth: 1600 });
                        const imgData = canvas.toDataURL('image/png');
                        
                        if (i > 0) pdf.addPage();
                        pdf.setFontSize(24);
                        pdf.setTextColor(40);
                        pdf.text(`${MONTHS[mIndex]} ${currentYear} - Strategic Planner`, 40, 40);
                        pdf.addImage(imgData, 'PNG', 40, 60, 1520, 900, undefined, 'FAST');
                    }
                    pdf.save(`Planner_${currentYear}.pdf`);
                } catch (e) {
                    console.error(e);
                    alert("Error generating PDF");
                } finally {
                    setCurrentMonth(originalMonth);
                    setZoomLevel(originalZoom);
                    setIsDownloading(false);
                    setIsDownloadModalOpen(false);
                    setDownloadStatus('');
                }
            };

            // Navigation Helpers
            const handleHeaderStatClick = (category) => {
                let relevantTasks = [];
                if (category === 'future') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'future').sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                } else if (category === 'pending') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'pending').sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                } else if (category === 'overdue') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'overdue').sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                } else if (category === 'completed') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'completed').sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
                }

                if (relevantTasks.length > 0) {
                    const targetTask = relevantTasks[0];
                    const targetDate = new Date(targetTask.startDate);
                    setCurrentYear(targetDate.getFullYear());
                    setCurrentMonth(targetDate.getMonth());
                } else {
                    alert(`No tasks found in "${category}" status.`);
                }
            };

            const handleNavigateFromStats = (pic, statusCategory) => {
                const relevantTasks = tasks.filter(t => {
                    const s = getTaskStatus(t);
                    const involved = t.pic.includes(pic);
                    if (!involved) return false;
                    if (statusCategory === 'completed') return s === 'completed';
                    if (statusCategory === 'pending') return s === 'future'; 
                    if (statusCategory === 'started') return s === 'pending' || s === 'overdue';
                    return false;
                });

                if (relevantTasks.length === 0) return;
                relevantTasks.sort((a, b) => {
                    const dateA = new Date(a.startDate);
                    const dateB = new Date(b.startDate);
                    return statusCategory === 'completed' ? dateB - dateA : dateA - dateB;
                });

                const targetTask = relevantTasks[0];
                const targetDate = new Date(targetTask.startDate);
                setCurrentYear(targetDate.getFullYear());
                setCurrentMonth(targetDate.getMonth());
                setFilterPic(pic);
                setIsTeamStatsOpen(false);
            };

            return (
                <div className="h-screen w-full flex flex-col overflow-hidden">
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 shadow-sm z-10 flex flex-col md:flex-row items-center justify-between p-4 gap-4">
                        <div className="flex items-center gap-4">
                            <img src="Logo ADTEC JTM 2025 Kampus Jerantut.jpg" alt="ADTEC Logo" className="h-12 w-auto object-contain" onError={(e) => e.target.style.display = 'none'} />
                            
                            {isAdmin ? (
                               <div className="relative group flex items-center gap-3">
                                 <img src="https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff&bold=true" alt="Profile" className="w-10 h-10 rounded-full border-2 border-indigo-600 shadow-md" />
                                 <div>
                                    <div className="text-sm font-bold text-slate-900">Administrator</div>
                                    <div className="text-xs text-green-600 flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online</div>
                                 </div>
                               </div>
                            ) : (
                                <div className="p-2 rounded-lg shadow-lg bg-slate-500"><Lock className="text-white w-6 h-6" /></div>
                            )}
                            
                            {!isAdmin && (
                                <div>
                                    <h1 className="text-xl font-bold text-slate-900 leading-tight">2026 Planner</h1>
                                    <div className="text-xs text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                        Read Only Mode
                                        {connectionStatus === 'connected' && <span className="text-emerald-500 flex items-center gap-1"><Wifi className="w-3 h-3"/> Cloud</span>}
                                        {connectionStatus === 'local' && <span className="text-amber-500 flex items-center gap-1"><Save className="w-3 h-3"/> Local</span>}
                                        {connectionStatus === 'error' && <span className="text-red-500 flex items-center gap-1"><WifiOff className="w-3 h-3"/> Offline</span>}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-4 bg-slate-100 p-2 rounded-xl">
                            <button onClick={() => setIsTeamStatsOpen(true)} className="flex flex-col items-center px-4 hover:bg-white rounded-lg transition-colors cursor-pointer group">
                                <BarChart3 className="w-5 h-5 text-indigo-600 group-hover:scale-110 transition-transform" />
                                <span className="text-[10px] text-slate-500 font-bold uppercase mt-1">Team</span>
                            </button>
                            <div className="h-8 w-px bg-slate-300 mx-1"></div>
                            
                            <StatPill label="Future" value={stats.future} color="text-indigo-600 bg-indigo-100" onClick={() => handleHeaderStatClick('future')} />
                            <StatPill label="Active" value={stats.pending} color="text-amber-600 bg-amber-100" onClick={() => handleHeaderStatClick('pending')} />
                            <StatPill label="Overdue" value={stats.overdue} color="text-red-600 bg-red-100" onClick={() => handleHeaderStatClick('overdue')} />
                            <StatPill label="Done" value={stats.completed} color="text-emerald-600 bg-emerald-100" onClick={() => handleHeaderStatClick('completed')} />
                        </div>

                        <div className="flex items-center gap-2">
                            <div className="relative group hidden md:block">
                                <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"/>
                                <input type="text" placeholder="Search task..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="pl-9 pr-4 py-2 bg-slate-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none w-48 transition-all" />
                            </div>
                            
                            <select value={filterPic} onChange={(e) => setFilterPic(e.target.value)} className="p-2 bg-slate-100 border-none rounded-lg text-xs font-bold text-slate-600 outline-none">
                                <option value="All">All Team</option>
                                {Object.keys(PIC_COLORS).filter(p => p !== 'Admin').map(p => <option key={p} value={p}>{p}</option>)}
                            </select>

                            <button onClick={() => setIsDownloadModalOpen(true)} className="p-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors flex items-center gap-2" title="Download PDF Options"><FileDown className="w-4 h-4" /></button>
                            
                            <div className="flex bg-slate-100 rounded-lg p-1 border border-slate-200">
                                <button onClick={() => handleZoom('out')} className="p-2 hover:bg-white hover:shadow rounded-md transition-all"><ZoomOut className="w-4 h-4 text-slate-600" /></button>
                                <span className="px-2 flex items-center text-xs font-mono text-slate-500 w-12 justify-center">{Math.round(zoomLevel * 100)}%</span>
                                <button onClick={() => handleZoom('in')} className="p-2 hover:bg-white hover:shadow rounded-md transition-all"><ZoomIn className="w-4 h-4 text-slate-600" /></button>
                            </div>

                            {isAdmin ? (
                                <button onClick={() => setIsAdmin(false)} className="ml-2 px-3 py-2 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg flex items-center gap-1 transition-colors"><LogOut className="w-3 h-3" /> Logout</button>
                            ) : (
                                <button onClick={() => setIsLoginModalOpen(true)} className="ml-2 px-4 py-2 text-sm font-bold text-white bg-slate-800 hover:bg-slate-900 rounded-lg shadow-lg flex items-center gap-1 transition-all">Admin Login</button>
                            )}
                        </div>
                    </header>

                    {/* Auth Error Banner */}
                    {authErrorMsg && (
                        <div className="bg-red-50 text-red-700 px-4 py-2 text-xs font-bold flex items-center justify-center border-b border-red-100">
                            <Info className="w-4 h-4 mr-2" />
                            {authErrorMsg}
                        </div>
                    )}

                    {/* Navigation */}
                    <div className="bg-white border-b border-slate-200 py-3 px-6 flex items-center justify-between">
                        <button onClick={() => setCurrentMonth(m => (m === 0 ? 11 : m - 1))} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><ChevronLeft className="w-5 h-5" /></button>
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">{MONTHS[currentMonth]} <span className="text-indigo-600">{currentYear}</span></h2>
                        <button onClick={() => setCurrentMonth(m => (m === 11 ? 0 : m + 1))} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><ChevronRight className="w-5 h-5" /></button>
                    </div>

                    {/* Board */}
                    <main className="flex-1 overflow-auto bg-slate-50 relative p-4 cursor-grab active:cursor-grabbing">
                        <div id="planner-board" style={{ transform: `scale(${zoomLevel})`, width: '100%', maxWidth: '1400px', minHeight: '800px', transformOrigin: 'top center' }} className="mx-auto shadow-2xl bg-white rounded-lg overflow-hidden border border-slate-300 transition-transform duration-200">
                            <div className="grid grid-cols-7 bg-slate-100 border-b border-slate-300">
                                {DAYS.map(day => <div key={day} className="py-3 text-center text-sm font-semibold text-slate-500 uppercase tracking-wider border-r border-slate-200 last:border-r-0">{day}</div>)}
                            </div>

                            <div className="grid grid-cols-7 auto-rows-fr bg-slate-200 gap-px border-b border-slate-200">
                                {calendarDays.map((cell) => {
                                    if (cell.type === 'empty') return <div key={cell.key} className="bg-slate-50/50 min-h-[140px]"></div>;

                                    const isToday = new Date().toDateString() === new Date(cell.dateKey).toDateString();
                                    const isWeekend = new Date(cell.dateKey).getDay() === 0 || new Date(cell.dateKey).getDay() === 6;
                                    
                                    const visibleTasks = cell.tasks.filter(t => {
                                        const searchLower = searchQuery.toLowerCase();
                                        const matchesSearch = t.title.toLowerCase().includes(searchLower) || t.pic.some(p => p.toLowerCase().includes(searchLower));
                                        const matchesPic = filterPic === 'All' || t.pic.includes(filterPic);
                                        return matchesSearch && matchesPic;
                                    });

                                    return (
                                        <div key={cell.dateKey} onClick={() => handleDayClick(cell.dateKey)} className={`relative min-h-[160px] p-2 transition-all hover:bg-blue-50/30 group ${cell.holiday ? 'bg-orange-50' : (isWeekend ? 'bg-yellow-50' : 'bg-white')} ${isToday ? 'ring-2 ring-indigo-500 ring-inset z-10' : ''} ${isAdmin ? 'cursor-pointer' : 'cursor-default'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className={`text-sm font-bold w-7 h-7 flex items-center justify-center rounded-full ${isToday ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-700'} ${cell.holiday ? 'text-orange-700' : ''}`}>{cell.day}</span>
                                                {cell.holiday && <span className="text-[10px] font-bold text-orange-700 bg-orange-100 px-1.5 py-0.5 rounded border border-orange-200 max-w-[80px] truncate leading-tight text-right">{cell.holiday}</span>}
                                            </div>
                                            {isAdmin && <button className="absolute top-2 left-10 opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-slate-200 rounded-full text-slate-400"><Plus className="w-3 h-3" /></button>}
                                            
                                            <div className="flex flex-col gap-1.5">
                                                {visibleTasks.map(task => {
                                                    const status = getTaskStatus(task);
                                                    const isCarried = task.isCarried;
                                                    const isDelayed = status === 'overdue';
                                                    
                                                    const isStart = cell.dateKey === task.startDate;
                                                    const isEnd = cell.dateKey === task.endDate;
                                                    const isMultiDay = task.startDate !== task.endDate;
                                                    const isBetween = !isStart && !isEnd && isMultiDay;

                                                    const barStyle = isBetween 
                                                        ? 'bg-blue-50 border-blue-200 opacity-80 border-dashed scale-95' 
                                                        : (isDelayed && !isCarried ? 'bg-red-50 border-red-300' : 'bg-white border-slate-200');

                                                    return (
                                                        <div key={task.id + (isCarried ? '-carried' : '')} onClick={(e) => handleTaskClick(e, task, cell.dateKey)} className={`border p-2 rounded shadow-sm text-xs cursor-pointer hover:shadow-md hover:-translate-y-0.5 transition-all relative overflow-hidden group/task ${barStyle} ${isCarried ? 'bg-red-50 border-red-400 border-dashed opacity-90' : ''} ${status === 'completed' ? 'opacity-60 grayscale' : ''} ${isDelayed ? 'animate-alert' : ''}`}>
                                                            {isStart && isMultiDay && <div className="absolute right-1 top-1 text-slate-300"><ArrowRight className="w-3 h-3" /></div>}
                                                            {isEnd && isMultiDay && <div className="absolute left-1 top-1 text-slate-300"><Flag className="w-3 h-3" /></div>}
                                                            {isCarried && <div className="flex items-center gap-1 text-[10px] text-red-600 font-bold mb-1"><AlertTriangle className="w-3 h-3" /> Delayed</div>}
                                                            <div className="flex flex-wrap gap-1 mb-1.5">
                                                                {(isStart || isEnd || !isMultiDay || isCarried) && task.pic.map(p => {
                                                                    const isDone = task.completedBy.includes(p);
                                                                    const isWaiting = (isDelayed || isCarried) && !isDone;
                                                                    return <button key={p} onClick={(e) => togglePicCompletion(e, task, p)} className={`px-1.5 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 transition-all ${isDone ? 'bg-emerald-100 text-emerald-800 border-emerald-300 ring-1 ring-emerald-400' : (isWaiting ? 'bg-red-100 text-red-800 border-red-300 ring-1 ring-red-400' : (PIC_COLORS[p] || PIC_COLORS['Admin']))} ${isAdmin ? 'hover:scale-105' : 'cursor-default'}`} title={isDone ? 'Completed' : 'Click to mark complete'}>{p} {isDone && <Check className="w-2.5 h-2.5" />}</button>
                                                                })}
                                                            </div>
                                                            <div className="flex items-center justify-between mb-1">
                                                                <div className={`font-medium leading-tight line-clamp-2 ${isBetween ? 'text-slate-400 italic' : 'text-slate-700'}`}>{isBetween ? '...' : task.title}</div>
                                                                <div className="flex items-center gap-1 shrink-0 ml-1">{task.attachments && task.attachments.length > 0 && <Paperclip className="w-3 h-3 text-slate-400" />}</div>
                                                            </div>
                                                            <div className={`h-1 w-full absolute bottom-0 left-0 ${status === 'future' ? 'bg-indigo-400' : ''} ${status === 'pending' ? 'bg-amber-400' : ''} ${status === 'completed' ? 'bg-emerald-400' : ''} ${status === 'overdue' ? 'bg-red-500' : ''}`}/>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </main>

                    <footer className="bg-white border-t border-slate-200 py-2 px-4 text-center">
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Owner: Bahagian Teknologi Rekabentuk Produk Industri</p>
                    </footer>

                    {isDownloading && (
                        <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black/80 backdrop-blur text-white">
                            <div className="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin mb-4"></div>
                            <h3 className="text-xl font-bold">Generating PDF Report</h3>
                            <p className="text-slate-300 mt-2">{downloadStatus}</p>
                        </div>
                    )}

                    {isTaskModalOpen && <TaskModal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} task={selectedTask} date={selectedDate} onSave={saveTask} onDelete={deleteTask} isAdmin={isAdmin} getTaskStatus={getTaskStatus} />}
                    {isLoginModalOpen && <LoginModal isOpen={isLoginModalOpen} onClose={() => setIsLoginModalOpen(false)} onLogin={handleLogin} />}
                    {isTeamStatsOpen && <TeamStatusModal isOpen={isTeamStatsOpen} onClose={() => setIsTeamStatsOpen(false)} tasks={tasks} onNavigate={handleNavigateFromStats} getTaskStatus={getTaskStatus} />}
                    {isDownloadModalOpen && <DownloadModal isOpen={isDownloadModalOpen} onClose={() => setIsDownloadModalOpen(false)} currentMonth={currentMonth} onGenerate={generatePDF} />}
                </div>
            );
        }

        // --- Sub-Components ---

        function StatPill({ label, value, color, onClick }) {
            return (
                <button onClick={onClick} className="flex flex-col items-center px-3 border-r border-slate-200 last:border-0 min-w-[70px] cursor-pointer hover:bg-slate-200 transition-colors rounded outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    <span className={`text-sm font-bold ${color.split(' ')[0]}`}>{value}</span>
                    <span className="text-[10px] text-slate-500 font-medium uppercase">{label}</span>
                </button>
            );
        }

        function DownloadModal({ isOpen, onClose, currentMonth, onGenerate }) {
            if (!isOpen) return null;
            const [selectedMonths, setSelectedMonths] = useState([currentMonth]);

            const toggleMonth = (idx) => {
                if (selectedMonths.includes(idx)) setSelectedMonths(prev => prev.filter(m => m !== idx));
                else setSelectedMonths(prev => [...prev, idx].sort((a,b) => a-b));
            };

            const selectAll = () => setSelectedMonths([0,1,2,3,4,5,6,7,8,9,10,11]);
            const selectCurrent = () => setSelectedMonths([currentMonth]);

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2"><FileDown className="w-5 h-5"/> Download PDF Report</h3>
                                <button onClick={onClose}><X className="w-5 h-5 text-slate-400"/></button>
                            </div>
                            
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <button onClick={selectCurrent} className="flex-1 py-2 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold">Current Month</button>
                                    <button onClick={selectAll} className="flex-1 py-2 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold">Full Year (12 Pages)</button>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Select Specific Months</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {MONTHS.map((m, idx) => (
                                            <button 
                                                key={m} 
                                                onClick={() => toggleMonth(idx)}
                                                className={`py-2 rounded text-xs font-medium border transition-colors ${selectedMonths.includes(idx) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300'}`}
                                            >
                                                {m}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button 
                                    onClick={() => onGenerate(selectedMonths)} 
                                    disabled={selectedMonths.length === 0}
                                    className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg shadow-indigo-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Generate PDF ({selectedMonths.length} pages)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function LoginModal({ isOpen, onClose, onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (username === 'admin' && password === 'admin') {
                    onLogin(username);
                } else {
                    setError('Invalid credentials. Use admin/admin');
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-6">
                            <div className="text-center mb-6">
                                <div className="bg-indigo-100 p-3 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3"><Lock className="w-6 h-6 text-indigo-600" /></div>
                                <h3 className="text-xl font-bold text-slate-900">Admin Access</h3>
                                <p className="text-sm text-slate-500">Enter your credentials to manage tasks.</p>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <input type="text" placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                {error && <p className="text-red-500 text-xs text-center font-bold bg-red-50 p-2 rounded">{error}</p>}
                                <button type="submit" className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg shadow-indigo-200 transition-all">Login</button>
                            </form>
                            <button onClick={onClose} className="w-full mt-3 py-2 text-slate-400 hover:text-slate-600 text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            )
        }

        function TeamStatusModal({ isOpen, onClose, tasks, onNavigate, getTaskStatus }) {
            if (!isOpen) return null;
            const picList = Object.keys(PIC_COLORS).filter(p => p !== 'Admin');
            
            const picStats = picList.map(pic => {
                const picTasks = tasks.filter(t => t.pic.includes(pic));
                return {
                    name: pic,
                    total: picTasks.length,
                    pending: picTasks.filter(t => getTaskStatus(t) === 'future').length,
                    started: picTasks.filter(t => getTaskStatus(t) === 'pending' || getTaskStatus(t) === 'overdue').length,
                    completed: picTasks.filter(t => getTaskStatus(t) === 'completed').length 
                };
            });

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col max-h-[90vh]">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center">
                            <h3 className="text-lg font-bold flex items-center gap-2">Team Performance</h3>
                            <button onClick={onClose}><X className="w-5 h-5 text-slate-400 hover:text-white" /></button>
                        </div>
                        <div className="p-6 overflow-auto">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {picStats.map(stat => (
                                    <div key={stat.name} className="border border-slate-200 rounded-xl p-4 hover:shadow-lg transition-shadow bg-white">
                                        <div className="flex items-center justify-between mb-4 pb-2 border-b border-slate-100">
                                            <div className="flex items-center gap-2">
                                                <div className={`w-3 h-3 rounded-full ${PIC_COLORS[stat.name].split(' ')[0].replace('bg-', 'bg-')}`}></div>
                                                <span className="font-bold text-slate-800">{stat.name}</span>
                                            </div>
                                            <span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-600">Total: {stat.total}</span>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden flex">
                                                <div style={{ width: `${(stat.completed / (stat.total || 1)) * 100}%` }} className="bg-emerald-500 h-full"></div>
                                                <div style={{ width: `${(stat.started / (stat.total || 1)) * 100}%` }} className="bg-blue-500 h-full"></div>
                                                <div style={{ width: `${(stat.pending / (stat.total || 1)) * 100}%` }} className="bg-indigo-400 h-full"></div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2 text-center text-xs">
                                                <div onClick={() => onNavigate(stat.name, 'pending')} className="bg-indigo-50 p-2 rounded text-indigo-700 font-medium cursor-pointer hover:bg-indigo-100 transition-colors group"><strong>{stat.pending}</strong> Future <span className="hidden group-hover:inline"></span></div>
                                                <div onClick={() => onNavigate(stat.name, 'started')} className="bg-blue-50 p-2 rounded text-blue-700 font-medium cursor-pointer hover:bg-blue-100 transition-colors group"><strong>{stat.started}</strong> Active <span className="hidden group-hover:inline"></span></div>
                                                <div onClick={() => onNavigate(stat.name, 'completed')} className="bg-emerald-50 p-2 rounded text-emerald-700 font-medium cursor-pointer hover:bg-emerald-100 transition-colors group"><strong>{stat.completed}</strong> Done <span className="hidden group-hover:inline"></span></div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function TaskModal({ isOpen, onClose, task, date, onSave, onDelete, isAdmin, getTaskStatus }) {
            const [formData, setFormData] = useState({ 
                title: '', 
                pic: [], 
                completedBy: [],
                description: '', 
                attachments: [],
                startDate: date,
                endDate: date
            });
            const [tempLink, setTempLink] = useState('');

            useEffect(() => {
                if (task) { 
                    const pics = Array.isArray(task.pic) ? task.pic : [task.pic];
                    const completed = Array.isArray(task.completedBy) ? task.completedBy : [];
                    setFormData({ ...task, pic: pics, completedBy: completed, attachments: task.attachments || [] }); 
                } 
                else { 
                    setFormData({ 
                        title: '', 
                        pic: [], 
                        completedBy: [],
                        description: '', 
                        attachments: [],
                        startDate: date,
                        endDate: date 
                    }); 
                }
            }, [task, date]);

            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
            
            const addLink = () => {
                if (!tempLink.trim()) return;
                setFormData(prev => ({
                    ...prev,
                    attachments: [...prev.attachments, { name: tempLink, type: 'link', url: tempLink }]
                }));
                setTempLink('');
            };
            
            const removeFile = (index) => { setFormData(prev => ({ ...prev, attachments: prev.attachments.filter((_, i) => i !== index) })); };

            const togglePic = (pic) => {
                if (!isAdmin) return;
                setFormData(prev => {
                    const current = prev.pic;
                    if (current.includes(pic)) {
                        return { 
                            ...prev, 
                            pic: current.filter(p => p !== pic),
                            completedBy: prev.completedBy.filter(p => p !== pic)
                        };
                    } else {
                        return { ...prev, pic: [...current, pic] };
                    }
                });
            };

            const toggleCompletion = (pic) => {
                if (!isAdmin) return;
                setFormData(prev => {
                    const current = prev.completedBy;
                    if (current.includes(pic)) {
                        return { ...prev, completedBy: current.filter(p => p !== pic) };
                    } else {
                        return { ...prev, completedBy: [...current, pic] };
                    }
                });
            };

            const handleSingleDelete = (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                if(confirm(`Remove only this specific day from the schedule?`)) onDelete(task.id, 'single');
            };

            const handleFullDelete = (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                if(confirm('Delete entire task and all its dates?')) onDelete(task.id, 'all');
            };

            if (!isOpen) return null;

            const isCarried = task?.isCarried;
            const canRemoveDay = task && !isCarried && formData.startDate !== formData.endDate;
            const currentStatus = task ? getTaskStatus(formData) : 'future'; 

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200 max-h-[90vh] flex flex-col">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-start shrink-0">
                            <div>
                                <h3 className="text-lg font-bold flex items-center gap-2">{isAdmin ? (task ? 'Edit Task' : 'New Task') : 'Task Details'}</h3>
                                <div className="flex items-center gap-2 text-slate-400 text-xs mt-1">
                                    <span className="flex items-center gap-1"><PlayCircle className="w-3 h-3"/> Start: {formData.startDate}</span>
                                    <span className="text-slate-600"></span>
                                    <span className="flex items-center gap-1"><Flag className="w-3 h-3"/> End: {formData.endDate}</span>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X className="w-5 h-5" /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4 overflow-y-auto">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Task / Duty</label>
                                <input required disabled={!isAdmin} type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-medium disabled:opacity-70 disabled:bg-slate-100" />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Start Date</label>
                                    <input required disabled={!isAdmin} type="date" value={formData.startDate} onChange={e => setFormData({...formData, startDate: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none disabled:opacity-70 disabled:bg-slate-100" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Completion Date</label>
                                    <input required disabled={!isAdmin} type="date" value={formData.endDate} onChange={e => setFormData({...formData, endDate: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none disabled:opacity-70 disabled:bg-slate-100" />
                                </div>
                            </div>
                            
                            {/* Auto Status Display */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Current Status (Auto)</label>
                                <div className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold capitalize 
                                    ${currentStatus === 'completed' ? 'bg-emerald-100 text-emerald-800' : 
                                      currentStatus === 'future' ? 'bg-indigo-100 text-indigo-800' :
                                      currentStatus === 'overdue' ? 'bg-red-100 text-red-800' : 
                                      'bg-blue-100 text-blue-800'}`}>
                                    {currentStatus}
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">PIC (Assign & Complete)</label>
                                <div className="flex flex-col gap-2">
                                    {Object.keys(PIC_COLORS).filter(p => p !== 'Admin').map(role => {
                                        const isAssigned = formData.pic.includes(role);
                                        const isCompleted = formData.completedBy.includes(role);
                                        
                                        return (
                                            <div key={role} className="flex items-center justify-between p-2 rounded border border-slate-100 hover:bg-slate-50">
                                                <div className="flex items-center gap-3">
                                                    {/* Assignment Toggle */}
                                                    <button
                                                        type="button"
                                                        onClick={() => togglePic(role)}
                                                        disabled={!isAdmin}
                                                        className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${isAssigned ? 'bg-slate-800 border-slate-800 text-white' : 'bg-white border-slate-300'}`}
                                                    >
                                                        {isAssigned && <Check className="w-3 h-3" />}
                                                    </button>
                                                    <span className={`text-sm font-bold ${isAssigned ? 'text-slate-800' : 'text-slate-400'}`}>{role}</span>
                                                </div>

                                                {/* Completion Toggle (Only if Assigned) */}
                                                {isAssigned && (
                                                    <button
                                                        type="button"
                                                        onClick={() => toggleCompletion(role)}
                                                        disabled={!isAdmin}
                                                        className={`px-3 py-1 text-xs rounded-full border transition-all ${isCompleted ? 'bg-emerald-100 text-emerald-800 border-emerald-300' : 'bg-slate-100 text-slate-500 border-slate-200'}`}
                                                    >
                                                        {isCompleted ? 'Completed' : 'Mark Done'}
                                                    </button>
                                                )}
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Details</label>
                                <textarea disabled={!isAdmin} rows={3} value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none disabled:opacity-70 disabled:bg-slate-100"></textarea>
                            </div>
                            
                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <div className="flex justify-between items-center mb-2">
                                     <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Memo Links & Resources</label>
                                </div>
                                {formData.attachments.length === 0 ? <div className="text-center py-4 text-slate-400 text-sm italic">No links added</div> : (
                                    <div className="space-y-2">{formData.attachments.map((file, idx) => (
                                        <div key={idx} className="flex items-center justify-between bg-white p-2 rounded border border-slate-200 shadow-sm">
                                            <div className="flex items-center gap-2 overflow-hidden">
                                                <div className="bg-indigo-100 p-1.5 rounded text-indigo-600"><Link className="w-4 h-4" /></div>
                                                <span className="text-sm truncate font-medium text-slate-700 max-w-[200px]" title={file.name}>{file.name}</span>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <a href={file.url} target="_blank" className="p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded" title="Open Link"><ExternalLink className="w-4 h-4"/></a>
                                                {isAdmin && <button type="button" onClick={() => removeFile(idx)} className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"><X className="w-4 h-4" /></button>}
                                            </div>
                                        </div>
                                    ))}</div>
                                )}
                                {isAdmin && (
                                    <div className="flex gap-2 mt-3 pt-2 border-t border-slate-200">
                                        <input
                                            type="text"
                                            value={tempLink}
                                            onChange={(e) => setTempLink(e.target.value)}
                                            placeholder="Paste memo link here..."
                                            className="flex-1 p-2 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-indigo-500 outline-none"
                                            onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addLink())}
                                        />
                                        <button type="button" onClick={addLink} className="p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors"><Plus className="w-4 h-4" /></button>
                                    </div>
                                )}
                            </div>
                            
                            {isAdmin && (
                                <div className="flex gap-3 pt-4 border-t border-slate-100 mt-4 shrink-0 flex-wrap">
                                    {task ? (
                                        <div className="flex gap-2 w-full">
                                            {canRemoveDay && (
                                                <button 
                                                    type="button" 
                                                    onClick={handleSingleDelete} 
                                                    className="px-3 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg text-xs flex items-center gap-1 font-bold border border-red-100"
                                                    title="Splits the task to remove this day"
                                                >
                                                    <Trash2 className="w-3 h-3" /> Remove Day
                                                </button>
                                            )}
                                            
                                            {/* Full Delete */}
                                            <button 
                                                type="button" 
                                                onClick={handleFullDelete} 
                                                className={`px-3 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg text-xs flex items-center gap-1 font-bold ${!canRemoveDay ? 'mr-auto' : ''}`}
                                            >
                                                <Trash2 className="w-3 h-3" /> Delete All
                                            </button>

                                            <div className="flex-1"></div>
                                            <button type="button" onClick={onClose} className="px-5 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                            <button type="submit" className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-sm">Save</button>
                                        </div>
                                    ) : (
                                        <div className="flex w-full">
                                            <div className="flex-1"></div>
                                            <div className="flex gap-2">
                                                <button type="button" onClick={onClose} className="px-5 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                                <button type="submit" className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-sm">Add Task</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {task && task.timestamp && (
                                <div className="text-[10px] text-slate-400 text-right mt-2 pt-2 border-t border-slate-100">
                                    Last Updated: {new Date(task.timestamp).toLocaleString('en-MY', { hour12: true, dateStyle: 'medium', timeStyle: 'short' })}
                                </div>
                            )}
                        </form>
                    </div>
                </div>
            );
        }

        // --- Init ---
        const root = createRoot(document.getElementById('root'));
        root.render(<PlannerApp />);
    </script>
</body>
</html>
