<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Strategic Planner (Local)</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Load PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @keyframes flash-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: rgb(252, 165, 165); }
            50% { box-shadow: 0 0 8px 1px rgba(239, 68, 68, 0.4); border-color: rgb(239, 68, 68); background-color: #fef2f2; }
        }
        .animate-alert {
            animation: flash-red 2s infinite;
        }
        
        .no-print {
            display: block;
        }
        /* Custom scrollbar for horizontal containers */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            ZoomIn, ZoomOut, Plus, Calendar as CalendarIcon, User, 
            CheckCircle, Clock, AlertCircle, X, Trash2, Search, 
            ChevronLeft, ChevronRight, Lock, Unlock, BarChart3, 
            Paperclip, FileText, LogOut, ShieldCheck, Eye, Download, Link,
            CheckSquare, Square, ArrowRight, ExternalLink, Flag, PlayCircle, Check, AlertTriangle, CalendarDays,
            Printer, FileDown, WifiOff, Wifi, Save, Database, Upload, FileJson, CloudOff, Info, HardDrive, FolderOpen, Share2, Camera, Cloud, RefreshCw
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- Constants ---

        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const DAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        const MALAYSIA_HOLIDAYS_2026 = {
            "2026-01-01": "New Year's Day",
            "2026-02-01": "Thaipusam (Est)",
            "2026-02-17": "Chinese New Year",
            "2026-02-18": "Chinese New Year Day 2",
            "2026-03-20": "Hari Raya Aidilfitri (Est)",
            "2026-03-21": "Hari Raya Aidilfitri Day 2 (Est)",
            "2026-05-01": "Labour Day",
            "2026-05-27": "Hari Raya Aidiladha (Est)",
            "2026-05-31": "Wesak Day (Est)",
            "2026-06-01": "Agong's Birthday",
            "2026-06-16": "Awal Muharram (Est)",
            "2026-08-31": "Merdeka Day",
            "2026-09-16": "Malaysia Day",
            "2026-09-24": "Prophet Muhammad's Birthday (Est)",
            "2026-11-08": "Deepavali (Est)",
            "2026-12-25": "Christmas Day"
        };

        const PIC_COLORS = {
            "Hilmy": "bg-blue-100 text-blue-800 border-blue-300",
            "Nadiah": "bg-pink-100 text-pink-800 border-pink-300",
            "Hasbalah": "bg-emerald-100 text-emerald-800 border-emerald-300",
            "Asmawi": "bg-purple-100 text-purple-800 border-purple-300",
            "Farah Idayu": "bg-yellow-100 text-yellow-800 border-yellow-300",
            "Fateha": "bg-orange-100 text-orange-800 border-orange-300",
            "Admin": "bg-gray-100 text-gray-800 border-gray-300"
        };

        // --- Helper Functions ---
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const formatDateKey = (year, month, day) => `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const parseDate = (str) => {
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        const addDays = (dateStr, days) => {
            const d = parseDate(dateStr);
            d.setDate(d.getDate() + days);
            return formatDateKey(d.getFullYear(), d.getMonth(), d.getDate());
        };

        const getTodayKey = () => {
            const d = new Date();
            return formatDateKey(d.getFullYear(), d.getMonth(), d.getDate());
        };

        // --- Main Component ---
        function PlannerApp() {
            const [currentYear, setCurrentYear] = useState(2026);
            const [currentMonth, setCurrentMonth] = useState(0); 
            const [zoomLevel, setZoomLevel] = useState(1);
            const [currentUser, setCurrentUser] = useState(null);
            const isAdmin = !!currentUser;
            
            // Data State
            const [tasks, setTasks] = useState([]);
            const [dataSource, setDataSource] = useState('local'); // 'local' or 'server'
            
            // UI State
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
            const [isTeamStatsOpen, setIsTeamStatsOpen] = useState(false);
            const [isDownloadModalOpen, setIsDownloadModalOpen] = useState(false);
            const [isDataModalOpen, setIsDataModalOpen] = useState(false);
            const [isDownloading, setIsDownloading] = useState(false);
            const [downloadStatus, setDownloadStatus] = useState('');
            
            const [selectedTask, setSelectedTask] = useState(null);
            const [selectedDate, setSelectedDate] = useState(null); 
            const [filterPic, setFilterPic] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');

            // --- Data Persistence (LocalStorage + Server Fetch) ---
            const loadData = async (isManualRefresh = false) => {
                // 1. Attempt to fetch 'planner_data.json' from the same directory (GitHub Repo)
                try {
                    // Add timestamp to bypass caching so users always get the latest push
                    const response = await fetch(`./planner_data.json?v=${new Date().getTime()}`);
                    if (response.ok) {
                        const serverData = await response.json();
                        if (Array.isArray(serverData)) {
                            setTasks(serverData);
                            setDataSource('server');
                            // Update local storage to match server
                            localStorage.setItem('planner_2026_tasks', JSON.stringify(serverData));
                            if (isManualRefresh) alert("✅ Data successfully refreshed from server!");
                            console.log("Sync: Loaded data from GitHub/Server file.");
                            return; 
                        }
                    } else if (isManualRefresh) {
                         alert("⚠️ Server file (planner_data.json) not found.");
                    }
                } catch (e) {
                    console.log("No server data file found (planner_data.json). Using local storage.");
                    if (isManualRefresh) alert("⚠️ Error connecting to server.");
                }

                // 2. Fallback to LocalStorage if server file missing
                const saved = localStorage.getItem('planner_2026_tasks');
                if (saved) {
                    try {
                        setTasks(JSON.parse(saved));
                        setDataSource('local');
                    } catch(e) {
                        console.error("Data parse error", e);
                        setTasks([]);
                    }
                } else {
                    // 3. Default Demo Data
                    setTasks([
                        {
                            id: "demo_1",
                            startDate: '2026-01-15',
                            endDate: '2026-01-15',
                            title: 'Q1 Strategy Meeting',
                            pic: ['Hilmy', 'Nadiah'], 
                            completedBy: ['Hilmy', 'Nadiah'], 
                            description: 'Discuss roadmap for 2026.',
                            attachments: [],
                            timestamp: new Date('2026-01-14T09:00:00').toISOString()
                        }
                    ]);
                }
            };

            const saveData = (newTasks) => {
                setTasks(newTasks);
                localStorage.setItem('planner_2026_tasks', JSON.stringify(newTasks));
            };
            
            const handleManualRefresh = () => {
                if (confirm("Refresh data from server?\n\nThis will overwrite local changes if a server file exists.")) {
                    loadData(true);
                }
            };

            useEffect(() => {
                loadData();
            }, []);

            // --- Status Logic ---
            const getTaskStatus = (task) => {
                const today = getTodayKey();
                const isFullyComplete = task.pic.length > 0 && task.pic.every(p => task.completedBy.includes(p));
                
                if (isFullyComplete) return 'completed';
                if (today > task.endDate) return 'overdue';
                if (today < task.startDate) return 'future'; 
                return 'pending'; // Active / In Progress
            };

            // Computed
            const calendarDays = useMemo(() => {
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                const firstDay = getFirstDayOfMonth(currentYear, currentMonth);
                const days = [];
                const todayKey = getTodayKey();

                const overdueTasks = tasks.filter(t => {
                    const isFullyComplete = t.pic.length > 0 && t.pic.every(p => t.completedBy.includes(p));
                    return t.endDate < todayKey && !isFullyComplete;
                });

                for (let i = 0; i < firstDay; i++) {
                    days.push({ type: 'empty', key: `empty-${i}` });
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = formatDateKey(currentYear, currentMonth, i);
                    let dayTasks = tasks.filter(t => dateKey >= t.startDate && dateKey <= t.endDate);

                    if (dateKey === todayKey) {
                        const carried = overdueTasks.map(t => ({ ...t, isCarried: true }));
                        const existingIds = new Set(dayTasks.map(t => t.id));
                        const uniqueCarried = carried.filter(c => !existingIds.has(c.id));
                        dayTasks = [...dayTasks, ...uniqueCarried];
                    }

                    days.push({
                        type: 'day',
                        day: i,
                        dateKey: dateKey,
                        holiday: MALAYSIA_HOLIDAYS_2026[dateKey],
                        tasks: dayTasks
                    });
                }
                return days;
            }, [currentYear, currentMonth, tasks]);

            const stats = useMemo(() => {
                const total = tasks.length;
                let completed = 0, future = 0, pending = 0, overdue = 0;
                
                tasks.forEach(t => {
                    const status = getTaskStatus(t);
                    if (status === 'completed') completed++;
                    else if (status === 'future') future++;
                    else if (status === 'overdue') overdue++;
                    else pending++; 
                });

                return { total, completed, future, pending, overdue };
            }, [tasks]);

            // Actions
            const handleZoom = (direction) => {
                setZoomLevel(prev => Math.min(Math.max(direction === 'in' ? prev + 0.1 : prev - 0.1, 0.5), 1.5));
            };

            const handleDayClick = (dateKey) => {
                if (!isAdmin) return;
                setSelectedDate(dateKey);
                setSelectedTask(null);
                setIsTaskModalOpen(true);
            };

            const handleTaskClick = (e, task, dateKey) => {
                e.stopPropagation();
                setSelectedTask(task);
                setSelectedDate(dateKey); 
                setIsTaskModalOpen(true);
            };

            const togglePicCompletion = (e, task, picName) => {
                e.stopPropagation();
                if (!isAdmin) return;

                const currentCompleted = task.completedBy || [];
                let newCompleted;
                if (currentCompleted.includes(picName)) {
                    newCompleted = currentCompleted.filter(p => p !== picName);
                } else {
                    newCompleted = [...currentCompleted, picName];
                }
                
                const updatedTasks = tasks.map(t => t.id === task.id ? { ...t, completedBy: newCompleted, timestamp: new Date().toISOString() } : t);
                saveData(updatedTasks);
            };

            const saveTask = (taskData) => {
                const { isCarried, id, ...cleanTask } = taskData;
                cleanTask.timestamp = new Date().toISOString();

                if (!cleanTask.completedBy) cleanTask.completedBy = [];
                if (cleanTask.endDate < cleanTask.startDate) cleanTask.endDate = cleanTask.startDate;

                let newTasks;
                if (selectedTask) {
                    newTasks = tasks.map(t => t.id === id ? { ...cleanTask, id } : t);
                } else {
                    const newTask = { ...cleanTask, id: Date.now().toString() };
                    newTasks = [...tasks, newTask];
                }
                saveData(newTasks);
                setIsTaskModalOpen(false);
            };

            const deleteTask = (id, mode) => {
                const targetId = String(id);
                let newTasks = [...tasks];

                if (mode === 'all') {
                    // Absolute Delete
                    newTasks = newTasks.filter(t => String(t.id) !== targetId);
                } 
                else if (mode === 'single' && selectedDate) {
                    // Split Logic
                    const taskIndex = tasks.findIndex(t => String(t.id) === targetId);
                    
                    if (taskIndex !== -1) {
                        const task = tasks[taskIndex];
                        const dateToDelete = selectedDate;

                        if (dateToDelete >= task.startDate && dateToDelete <= task.endDate) {
                            if (task.startDate === task.endDate) {
                                // Single day task -> Delete all
                                newTasks = newTasks.filter(t => String(t.id) !== targetId);
                            } else if (dateToDelete === task.startDate) {
                                // Trim Start
                                const newStart = addDays(task.startDate, 1);
                                newTasks[taskIndex] = { ...task, startDate: newStart };
                            } else if (dateToDelete === task.endDate) {
                                // Trim End
                                const newEnd = addDays(task.endDate, -1);
                                newTasks[taskIndex] = { ...task, endDate: newEnd };
                            } else {
                                // Split Middle
                                const endA = addDays(dateToDelete, -1);
                                const startB = addDays(dateToDelete, 1);
                                
                                const taskA = { ...task, endDate: endA };
                                const taskB = { ...task, id: Date.now().toString(), startDate: startB };
                                
                                newTasks = [
                                    ...newTasks.slice(0, taskIndex), 
                                    taskA, 
                                    taskB, 
                                    ...newTasks.slice(taskIndex + 1)
                                ];
                            }
                        }
                    }
                }
                
                saveData(newTasks);
                setIsTaskModalOpen(false);
            };

            // Data Import/Export Handlers
            const handleExportData = () => {
                const dataStr = JSON.stringify(tasks, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `planner_data.json`; // MATCHES THE AUTO-LOAD FILENAME
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedTasks = JSON.parse(event.target.result);
                        if (!Array.isArray(importedTasks)) throw new Error("Invalid format");
                        
                        if (confirm(`Restore ${importedTasks.length} tasks? Current data will be replaced.`)) {
                            saveData(importedTasks);
                            setIsDataModalOpen(false);
                            alert("Data restored successfully!");
                        }
                    } catch (err) {
                        alert("Error reading file.");
                    }
                };
                reader.readAsText(file);
            };

            const handleLogin = (username) => {
                setCurrentUser({
                    name: "Admin",
                    email: "admin@system",
                    avatar: "https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff&bold=true"
                });
                setIsLoginModalOpen(false);
            };

            // PDF Generation
            const generatePDF = async (monthsToPrint) => {
                setIsDownloading(true);
                const element = document.getElementById('planner-board');
                if (!element) return;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [1600, 1000] }); 
                
                const originalMonth = currentMonth;
                const originalZoom = zoomLevel;
                setZoomLevel(1); 

                try {
                    for (let i = 0; i < monthsToPrint.length; i++) {
                        const mIndex = monthsToPrint[i];
                        setCurrentMonth(mIndex);
                        setDownloadStatus(`Rendering ${MONTHS[mIndex]}...`);
                        await new Promise(r => setTimeout(r, 600)); 

                        const canvas = await window.html2canvas(element, { scale: 1.5, useCORS: true, logging: false, windowWidth: 1600 });
                        const imgData = canvas.toDataURL('image/png');
                        
                        if (i > 0) pdf.addPage();
                        pdf.setFontSize(24);
                        pdf.setTextColor(40);
                        pdf.text(`${MONTHS[mIndex]} ${currentYear} - Strategic Planner`, 40, 40);
                        pdf.addImage(imgData, 'PNG', 40, 60, 1520, 900, undefined, 'FAST');
                    }
                    pdf.save(`Planner_${currentYear}.pdf`);
                } catch (e) {
                    console.error(e);
                    alert("Error generating PDF");
                } finally {
                    setCurrentMonth(originalMonth);
                    setZoomLevel(originalZoom);
                    setIsDownloading(false);
                    setIsDownloadModalOpen(false);
                    setDownloadStatus('');
                }
            };
            
            // WHATSAPP SNAPSHOT LOGIC
            const handleWhatsAppSnapshot = async () => {
                setIsDownloading(true);
                setDownloadStatus('Capturing Planner...');
                
                const element = document.getElementById('planner-board');
                if (!element) return;
                
                // Backup state
                const originalZoom = zoomLevel;
                setZoomLevel(1); // Standard zoom for clear text
                
                try {
                    // Wait for zoom to apply
                    await new Promise(r => setTimeout(r, 300));
                    
                    const canvas = await window.html2canvas(element, { 
                        scale: 1.5, 
                        useCORS: true, 
                        logging: false 
                    });
                    
                    canvas.toBlob(async (blob) => {
                        try {
                            const item = new ClipboardItem({ 'image/png': blob });
                            await navigator.clipboard.write([item]);
                            
                            alert("✅ Snapshot copied to clipboard!\n\nWhatsApp Web will now open.\nSimply PASTE (Ctrl+V) into the chat to send.");
                            window.open('https://web.whatsapp.com/', '_blank');
                        } catch (err) {
                            // Fallback for browsers blocking clipboard write without direct user gesture interaction in this async flow
                            console.error(err);
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'planner-snapshot.png';
                            a.click();
                            alert("⚠️ Couldn't auto-copy to clipboard (Browser Security).\n\nThe image has been DOWNLOADED instead.\n\nPlease drag & drop it into WhatsApp.");
                            window.open('https://web.whatsapp.com/', '_blank');
                        }
                    });

                } catch (e) {
                    console.error("Snapshot failed", e);
                    alert("Failed to capture snapshot.");
                } finally {
                    setZoomLevel(originalZoom);
                    setIsDownloading(false);
                    setDownloadStatus('');
                }
            };

            // Navigation Helpers
            const handleHeaderStatClick = (category) => {
                let relevantTasks = [];
                if (category === 'future') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'future').sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                } else if (category === 'pending') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'pending').sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                } else if (category === 'overdue') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'overdue').sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                } else if (category === 'completed') {
                    relevantTasks = tasks.filter(t => getTaskStatus(t) === 'completed').sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
                }

                if (relevantTasks.length > 0) {
                    const targetTask = relevantTasks[0];
                    const targetDate = new Date(targetTask.startDate);
                    setCurrentYear(targetDate.getFullYear());
                    setCurrentMonth(targetDate.getMonth());
                } else {
                    alert(`No tasks found in "${category}" status.`);
                }
            };

            const handleNavigateFromStats = (pic, statusCategory) => {
                const relevantTasks = tasks.filter(t => {
                    const s = getTaskStatus(t);
                    const involved = t.pic.includes(pic);
                    if (!involved) return false;
                    if (statusCategory === 'completed') return s === 'completed';
                    if (statusCategory === 'pending') return s === 'future'; 
                    if (statusCategory === 'started') return s === 'pending' || s === 'overdue';
                    return false;
                });

                if (relevantTasks.length === 0) return;
                relevantTasks.sort((a, b) => {
                    const dateA = new Date(a.startDate);
                    const dateB = new Date(b.startDate);
                    return statusCategory === 'completed' ? dateB - dateA : dateA - dateB;
                });

                const targetTask = relevantTasks[0];
                const targetDate = new Date(targetTask.startDate);
                setCurrentYear(targetDate.getFullYear());
                setCurrentMonth(targetDate.getMonth());
                setFilterPic(pic);
                setIsTeamStatsOpen(false);
            };

            return (
                <div className="h-screen w-full flex flex-col overflow-hidden">
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 shadow-sm z-10 flex flex-wrap items-center justify-between p-4 gap-4 shrink-0">
                        <div className="flex items-center gap-4">
                            {/* Logo Section */}
                            <img src="Logo ADTEC JTM 2025 Kampus Jerantut.jpg" alt="ADTEC Logo" className="h-12 w-auto object-contain" onError={(e) => e.target.style.display = 'none'} />
                            
                            {isAdmin ? (
                               <div className="relative group flex items-center gap-3">
                                 <img src="https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff&bold=true" alt="Profile" className="w-10 h-10 rounded-full border-2 border-indigo-600 shadow-md" />
                                 <div>
                                    <div className="text-sm font-bold text-slate-900">Administrator</div>
                                    <div className="text-xs text-green-600 flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online</div>
                                 </div>
                               </div>
                            ) : (
                                <div className="p-2 rounded-lg shadow-lg bg-slate-500"><Lock className="text-white w-6 h-6" /></div>
                            )}
                            
                            {!isAdmin && (
                                <div>
                                    <h1 className="text-xl font-bold text-slate-900 leading-tight">2026 Planner</h1>
                                    <div className="text-xs text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                        Read Only Mode
                                        {dataSource === 'server' 
                                            ? <span className="text-emerald-500 flex items-center gap-1"><Cloud className="w-3 h-3"/> Synced</span>
                                            : <span className="text-amber-500 flex items-center gap-1"><HardDrive className="w-3 h-3"/> Local</span>
                                        }
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-4 bg-slate-100 p-2 rounded-xl overflow-x-auto max-w-full no-scrollbar">
                            <button onClick={() => setIsTeamStatsOpen(true)} className="flex flex-col items-center px-4 hover:bg-white rounded-lg transition-colors cursor-pointer group">
                                <BarChart3 className="w-5 h-5 text-indigo-600 group-hover:scale-110 transition-transform" />
                                <span className="text-[10px] text-slate-500 font-bold uppercase mt-1">Status</span>
                            </button>
                            <div className="h-8 w-px bg-slate-300 mx-1"></div>
                            
                            <StatPill label="Future" value={stats.future} color="text-indigo-600 bg-indigo-100" onClick={() => handleHeaderStatClick('future')} />
                            <StatPill label="Active" value={stats.pending} color="text-amber-600 bg-amber-100" onClick={() => handleHeaderStatClick('pending')} />
                            <StatPill label="Overdue" value={stats.overdue} color="text-red-600 bg-red-100" onClick={() => handleHeaderStatClick('overdue')} />
                            <StatPill label="Done" value={stats.completed} color="text-emerald-600 bg-emerald-100" onClick={() => handleHeaderStatClick('completed')} />
                        </div>

                        <div className="flex flex-wrap items-center gap-2 justify-end flex-1">
                            <div className="relative group">
                                <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"/>
                                <input type="text" placeholder="Search..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="pl-9 pr-4 py-2 bg-slate-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none w-32 sm:w-48 transition-all" />
                            </div>
                            
                            <select value={filterPic} onChange={(e) => setFilterPic(e.target.value)} className="p-2 bg-slate-100 border-none rounded-lg text-xs font-bold text-slate-600 outline-none">
                                <option value="All">All Team</option>
                                {Object.keys(PIC_COLORS).filter(p => p !== 'Admin').map(p => <option key={p} value={p}>{p}</option>)}
                            </select>

                            {/* Refresh Button */}
                            <button onClick={handleManualRefresh} className="p-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition-colors" title="Refresh Data from Server">
                                <RefreshCw className="w-4 h-4" />
                            </button>
                            
                            {/* Save Button (Admin Only) */}
                            {isAdmin && (
                                <button onClick={handleExportData} className="p-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg transition-colors" title="Save / Export Session">
                                    <Save className="w-4 h-4" />
                                </button>
                            )}

                            <button onClick={() => setIsDownloadModalOpen(true)} className="p-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors flex items-center gap-2" title="Download PDF Options"><FileDown className="w-4 h-4" /></button>
                            
                            {/* WhatsApp Snapshot Button */}
                            <button onClick={handleWhatsAppSnapshot} className="p-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors flex items-center gap-2" title="WhatsApp Snapshot"><Camera className="w-4 h-4" /></button>

                            {/* Backup Button - Visible to Everyone */}
                            <button onClick={() => setIsDataModalOpen(true)} className="p-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors" title="Backup / Restore"><Database className="w-4 h-4" /></button>

                            <div className="flex bg-slate-100 rounded-lg p-1 border border-slate-200">
                                <button onClick={() => handleZoom('out')} className="p-2 hover:bg-white hover:shadow rounded-md transition-all"><ZoomOut className="w-4 h-4 text-slate-600" /></button>
                                <span className="px-2 flex items-center text-xs font-mono text-slate-500 w-12 justify-center">{Math.round(zoomLevel * 100)}%</span>
                                <button onClick={() => handleZoom('in')} className="p-2 hover:bg-white hover:shadow rounded-md transition-all"><ZoomIn className="w-4 h-4 text-slate-600" /></button>
                            </div>

                            {isAdmin ? (
                                <button onClick={() => setCurrentUser(null)} className="ml-2 px-3 py-2 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg flex items-center gap-1 transition-colors"><LogOut className="w-3 h-3" /> Logout</button>
                            ) : (
                                <button onClick={() => setIsLoginModalOpen(true)} className="ml-2 px-4 py-2 text-sm font-bold text-white bg-slate-800 hover:bg-slate-900 rounded-lg shadow-lg flex items-center gap-1 transition-all">Admin Login</button>
                            )}
                        </div>
                    </header>

                    {/* Navigation */}
                    <div className="bg-white border-b border-slate-200 py-3 px-6 flex items-center justify-between">
                        <button onClick={() => setCurrentMonth(m => (m === 0 ? 11 : m - 1))} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><ChevronLeft className="w-5 h-5" /></button>
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">{MONTHS[currentMonth]} <span className="text-indigo-600">{currentYear}</span></h2>
                        <button onClick={() => setCurrentMonth(m => (m === 11 ? 0 : m + 1))} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><ChevronRight className="w-5 h-5" /></button>
                    </div>

                    {/* Board */}
                    <main className="flex-1 overflow-auto bg-slate-50 relative p-4 cursor-grab active:cursor-grabbing">
                        <div id="planner-board" style={{ transform: `scale(${zoomLevel})`, width: '100%', maxWidth: '1400px', minHeight: '800px', transformOrigin: 'top center' }} className="mx-auto shadow-2xl bg-white rounded-lg overflow-hidden border border-slate-300 transition-transform duration-200">
                            <div className="grid grid-cols-7 bg-slate-100 border-b border-slate-300">
                                {DAYS.map(day => <div key={day} className="py-3 text-center text-sm font-semibold text-slate-500 uppercase tracking-wider border-r border-slate-200 last:border-r-0">{day}</div>)}
                            </div>

                            <div className="grid grid-cols-7 auto-rows-fr bg-slate-200 gap-px border-b border-slate-200">
                                {calendarDays.map((cell) => {
                                    if (cell.type === 'empty') return <div key={cell.key} className="bg-slate-50/50 min-h-[140px]"></div>;

                                    const isToday = new Date().toDateString() === new Date(cell.dateKey).toDateString();
                                    const isWeekend = new Date(cell.dateKey).getDay() === 0 || new Date(cell.dateKey).getDay() === 6;
                                    
                                    const visibleTasks = cell.tasks.filter(t => {
                                        const searchLower = searchQuery.toLowerCase();
                                        const matchesSearch = t.title.toLowerCase().includes(searchLower) || t.pic.some(p => p.toLowerCase().includes(searchLower));
                                        const matchesPic = filterPic === 'All' || t.pic.includes(filterPic);
                                        return matchesSearch && matchesPic;
                                    });

                                    return (
                                        <div key={cell.dateKey} onClick={() => handleDayClick(cell.dateKey)} className={`relative min-h-[160px] p-2 transition-all hover:bg-blue-50/30 group ${cell.holiday ? 'bg-orange-50' : (isWeekend ? 'bg-yellow-50' : 'bg-white')} ${isToday ? 'ring-2 ring-indigo-500 ring-inset z-10' : ''} ${isAdmin ? 'cursor-pointer' : 'cursor-default'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className={`text-sm font-bold w-7 h-7 flex items-center justify-center rounded-full ${isToday ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-700'} ${cell.holiday ? 'text-orange-700' : ''}`}>{cell.day}</span>
                                                {cell.holiday && <span className="text-[10px] font-bold text-orange-700 bg-orange-100 px-1.5 py-0.5 rounded border border-orange-200 max-w-[80px] truncate leading-tight text-right">{cell.holiday}</span>}
                                            </div>
                                            {isAdmin && <button className="absolute top-2 left-10 opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-slate-200 rounded-full text-slate-400"><Plus className="w-3 h-3" /></button>}
                                            
                                            <div className="flex flex-col gap-1.5">
                                                {visibleTasks.map(task => {
                                                    const status = getTaskStatus(task);
                                                    const isCarried = task.isCarried;
                                                    const isDelayed = status === 'overdue';
                                                    
                                                    const isStart = cell.dateKey === task.startDate;
                                                    const isEnd = cell.dateKey === task.endDate;
                                                    const isMultiDay = task.startDate !== task.endDate;
                                                    const isBetween = !isStart && !isEnd && isMultiDay;

                                                    const barStyle = isBetween 
                                                        ? 'bg-blue-50 border-blue-200 opacity-80 border-dashed scale-95' 
                                                        : (isDelayed && !isCarried ? 'bg-red-50 border-red-300' : 'bg-white border-slate-200');

                                                    return (
                                                        <div key={task.id + (isCarried ? '-carried' : '')} onClick={(e) => handleTaskClick(e, task, cell.dateKey)} className={`border p-2 rounded shadow-sm text-xs cursor-pointer hover:shadow-md hover:-translate-y-0.5 transition-all relative overflow-hidden group/task ${barStyle} ${isCarried ? 'bg-red-50 border-red-400 border-dashed opacity-90' : ''} ${status === 'completed' ? 'opacity-60 grayscale' : ''} ${isDelayed ? 'animate-alert' : ''}`}>
                                                            {isStart && isMultiDay && <div className="absolute right-1 top-1 text-slate-300"><ArrowRight className="w-3 h-3" /></div>}
                                                            {isEnd && isMultiDay && <div className="absolute left-1 top-1 text-slate-300"><Flag className="w-3 h-3" /></div>}
                                                            {isCarried && <div className="flex items-center gap-1 text-[10px] text-red-600 font-bold mb-1"><AlertTriangle className="w-3 h-3" /> Delayed</div>}
                                                            <div className="flex flex-wrap gap-1 mb-1.5">
                                                                {(isStart || isEnd || !isMultiDay || isCarried) && task.pic.map(p => {
                                                                    const isDone = task.completedBy.includes(p);
                                                                    const isWaiting = (isDelayed || isCarried) && !isDone;
                                                                    return <button key={p} onClick={(e) => togglePicCompletion(e, task, p)} className={`px-1.5 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 transition-all ${isDone ? 'bg-emerald-100 text-emerald-800 border-emerald-300 ring-1 ring-emerald-400' : (isWaiting ? 'bg-red-100 text-red-800 border-red-300 ring-1 ring-red-400' : (PIC_COLORS[p] || PIC_COLORS['Admin']))} ${isAdmin ? 'hover:scale-105' : 'cursor-default'}`} title={isDone ? 'Completed' : 'Click to mark complete'}>{p} {isDone && <Check className="w-2.5 h-2.5" />}</button>
                                                                })}
                                                            </div>
                                                            <div className="flex items-center justify-between mb-1">
                                                                <div className={`font-medium leading-tight line-clamp-2 ${isBetween ? 'text-slate-400 italic' : 'text-slate-700'}`}>{isBetween ? '...' : task.title}</div>
                                                                <div className="flex items-center gap-1 shrink-0 ml-1">{task.attachments && task.attachments.length > 0 && <Paperclip className="w-3 h-3 text-slate-400" />}</div>
                                                            </div>
                                                            <div className={`h-1 w-full absolute bottom-0 left-0 ${status === 'future' ? 'bg-indigo-400' : ''} ${status === 'pending' ? 'bg-amber-400' : ''} ${status === 'completed' ? 'bg-emerald-400' : ''} ${status === 'overdue' ? 'bg-red-500' : ''}`}/>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </main>

                    <footer className="bg-white border-t border-slate-200 py-2 px-4 text-center">
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Owner: Bahagian Teknologi Rekabentuk Produk Industri</p>
                    </footer>

                    {isDownloading && (
                        <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black/80 backdrop-blur text-white">
                            <div className="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin mb-4"></div>
                            <h3 className="text-xl font-bold">Generating PDF Report</h3>
                            <p className="text-slate-300 mt-2">{downloadStatus}</p>
                        </div>
                    )}

                    {isTaskModalOpen && <TaskModal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} task={selectedTask} date={selectedDate} onSave={saveTask} onDelete={deleteTask} isAdmin={isAdmin} getTaskStatus={getTaskStatus} />}
                    {isLoginModalOpen && <LoginModal isOpen={isLoginModalOpen} onClose={() => setIsLoginModalOpen(false)} onLogin={handleLogin} />}
                    {isTeamStatsOpen && <TeamStatusModal isOpen={isTeamStatsOpen} onClose={() => setIsTeamStatsOpen(false)} tasks={tasks} onNavigate={handleNavigateFromStats} getTaskStatus={getTaskStatus} />}
                    {isDownloadModalOpen && <DownloadModal isOpen={isDownloadModalOpen} onClose={() => setIsDownloadModalOpen(false)} currentMonth={currentMonth} onGenerate={generatePDF} />}
                    
                    {/* Data Modal */}
                    {isDataModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2"><Database className="w-5 h-5"/> Backup / Restore</h3>
                                        <button onClick={() => setIsDataModalOpen(false)}><X className="w-5 h-5 text-slate-400"/></button>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="bg-slate-50 p-3 rounded text-xs text-slate-600 border border-slate-200 mb-4">
                                            <strong>Admins:</strong> Click "Export Backup" to download your data file. Then, upload it to the Google Drive folder linked below to share with your team.<br/><br/>
                                            <strong>Team:</strong> The app auto-checks for <code>planner_data.json</code> on load. If that fails or you need a specific version, download it from Drive and click "Restore Backup" here.
                                        </div>
                                        
                                        {/* Direct Drive Link */}
                                        <a href="https://drive.google.com/drive/folders/1s9IRJjdK7RadoKP41I93rl8pPuXJV4zh?usp=sharing" target="_blank" className="w-full py-3 bg-indigo-50 border border-indigo-200 text-indigo-700 hover:bg-indigo-100 rounded-lg font-bold flex items-center justify-center gap-2 transition-all">
                                            <FolderOpen className="w-4 h-4" /> Open Your Google Drive Folder
                                        </a>

                                        {isAdmin && (
                                            <button onClick={handleExportData} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-all">
                                                <FileJson className="w-4 h-4" /> Export Backup (planner_data.json)
                                            </button>
                                        )}
                                        
                                        <div className="relative">
                                            <input type="file" id="import-file" className="hidden" accept=".json" onChange={handleImportData} />
                                            <label htmlFor="import-file" className="w-full py-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-all cursor-pointer">
                                                <Upload className="w-4 h-4" /> Restore Backup (.json)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Sub-Components ---

        function StatPill({ label, value, color, onClick }) {
            return (
                <button onClick={onClick} className="flex flex-col items-center px-3 border-r border-slate-200 last:border-0 min-w-[70px] cursor-pointer hover:bg-slate-200 transition-colors rounded outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 shrink-0">
                    <span className={`text-sm font-bold ${color.split(' ')[0]}`}>{value}</span>
                    <span className="text-[10px] text-slate-500 font-medium uppercase">{label}</span>
                </button>
            );
        }

        function DownloadModal({ isOpen, onClose, currentMonth, onGenerate }) {
            if (!isOpen) return null;
            const [selectedMonths, setSelectedMonths] = useState([currentMonth]);

            const toggleMonth = (idx) => {
                if (selectedMonths.includes(idx)) setSelectedMonths(prev => prev.filter(m => m !== idx));
                else setSelectedMonths(prev => [...prev, idx].sort((a,b) => a-b));
            };

            const selectAll = () => setSelectedMonths([0,1,2,3,4,5,6,7,8,9,10,11]);
            const selectCurrent = () => setSelectedMonths([currentMonth]);

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2"><FileDown className="w-5 h-5"/> Download PDF Report</h3>
                                <button onClick={onClose}><X className="w-5 h-5 text-slate-400"/></button>
                            </div>
                            
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <button onClick={selectCurrent} className="flex-1 py-2 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold">Current Month</button>
                                    <button onClick={selectAll} className="flex-1 py-2 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold">Full Year (12 Pages)</button>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Select Specific Months</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {MONTHS.map((m, idx) => (
                                            <button 
                                                key={m} 
                                                onClick={() => toggleMonth(idx)}
                                                className={`py-2 rounded text-xs font-medium border transition-colors ${selectedMonths.includes(idx) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300'}`}
                                            >
                                                {m}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button 
                                    onClick={() => onGenerate(selectedMonths)} 
                                    disabled={selectedMonths.length === 0}
                                    className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg shadow-indigo-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Generate PDF ({selectedMonths.length} pages)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function LoginModal({ isOpen, onClose, onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (username === 'admin' && password === 'admin') {
                    onLogin(username);
                } else {
                    setError('Invalid credentials. Use admin/admin');
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-6">
                            <div className="text-center mb-6">
                                <div className="bg-indigo-100 p-3 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3"><Lock className="w-6 h-6 text-indigo-600" /></div>
                                <h3 className="text-xl font-bold text-slate-900">Admin Access</h3>
                                <p className="text-sm text-slate-500">Enter your credentials to manage tasks.</p>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <input type="text" placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                {error && <p className="text-red-500 text-xs text-center font-bold bg-red-50 p-2 rounded">{error}</p>}
                                <button type="submit" className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg shadow-indigo-200 transition-all">Login</button>
                            </form>
                            <button onClick={onClose} className="w-full mt-3 py-2 text-slate-400 hover:text-slate-600 text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            )
        }

        function TeamStatusModal({ isOpen, onClose, tasks, onNavigate, getTaskStatus }) {
            if (!isOpen) return null;
            const picList = Object.keys(PIC_COLORS).filter(p => p !== 'Admin');
            
            const picStats = picList.map(pic => {
                const picTasks = tasks.filter(t => t.pic.includes(pic));
                return {
                    name: pic,
                    total: picTasks.length,
                    pending: picTasks.filter(t => getTaskStatus(t) === 'future').length,
                    started: picTasks.filter(t => getTaskStatus(t) === 'pending' || getTaskStatus(t) === 'overdue').length,
                    completed: picTasks.filter(t => getTaskStatus(t) === 'completed').length 
                };
            });

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col max-h-[90vh]">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center">
                            <h3 className="text-lg font-bold flex items-center gap-2">Team Performance</h3>
                            <button onClick={onClose}><X className="w-5 h-5 text-slate-400 hover:text-white" /></button>
                        </div>
                        <div className="p-6 overflow-auto">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {picStats.map(stat => (
                                    <div key={stat.name} className="border border-slate-200 rounded-xl p-4 hover:shadow-lg transition-shadow bg-white">
                                        <div className="flex items-center justify-between mb-4 pb-2 border-b border-slate-100">
                                            <div className="flex items-center gap-2">
                                                <div className={`w-3 h-3 rounded-full ${PIC_COLORS[stat.name].split(' ')[0].replace('bg-', 'bg-')}`}></div>
                                                <span className="font-bold text-slate-800">{stat.name}</span>
                                            </div>
                                            <span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-600">Total: {stat.total}</span>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden flex">
                                                <div style={{ width: `${(stat.completed / (stat.total || 1)) * 100}%` }} className="bg-emerald-500 h-full"></div>
                                                <div style={{ width: `${(stat.started / (stat.total || 1)) * 100}%` }} className="bg-blue-500 h-full"></div>
                                                <div style={{ width: `${(stat.pending / (stat.total || 1)) * 100}%` }} className="bg-indigo-400 h-full"></div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2 text-center text-xs">
                                                <div onClick={() => onNavigate(stat.name, 'pending')} className="bg-indigo-50 p-2 rounded text-indigo-700 font-medium cursor-pointer hover:bg-indigo-100 transition-colors group"><strong>{stat.pending}</strong> Future <span className="hidden group-hover:inline">→</span></div>
                                                <div onClick={() => onNavigate(stat.name, 'started')} className="bg-blue-50 p-2 rounded text-blue-700 font-medium cursor-pointer hover:bg-blue-100 transition-colors group"><strong>{stat.started}</strong> Active <span className="hidden group-hover:inline">→</span></div>
                                                <div onClick={() => onNavigate(stat.name, 'completed')} className="bg-emerald-50 p-2 rounded text-emerald-700 font-medium cursor-pointer hover:bg-emerald-100 transition-colors group"><strong>{stat.completed}</strong> Done <span className="hidden group-hover:inline">→</span></div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function TaskModal({ isOpen, onClose, task, date, onSave, onDelete, isAdmin, getTaskStatus }) {
            // Initial state handles both new tasks and editing existing ones
            const [formData, setFormData] = useState({ 
                title: '', 
                pic: [], 
                completedBy: [],
                description: '', 
                attachments: [],
                startDate: date,
                endDate: date
            });
            const [tempLink, setTempLink] = useState('');

            useEffect(() => {
                if (task) { 
                    const pics = Array.isArray(task.pic) ? task.pic : [task.pic];
                    const completed = Array.isArray(task.completedBy) ? task.completedBy : [];
                    setFormData({ ...task, pic: pics, completedBy: completed, attachments: task.attachments || [] }); 
                } 
                else { 
                    setFormData({ 
                        title: '', 
                        pic: [], 
                        completedBy: [],
                        description: '', 
                        attachments: [],
                        startDate: date,
                        endDate: date 
                    }); 
                }
            }, [task, date]);

            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
            
            const addLink = () => {
                if (!tempLink.trim()) return;
                setFormData(prev => ({
                    ...prev,
                    attachments: [...prev.attachments, { name: tempLink, type: 'link', url: tempLink }]
                }));
                setTempLink('');
            };
            
            const removeFile = (index) => { setFormData(prev => ({ ...prev, attachments: prev.attachments.filter((_, i) => i !== index) })); };

            const togglePic = (pic) => {
                if (!isAdmin) return;
                setFormData(prev => {
                    const current = prev.pic;
                    if (current.includes(pic)) {
                        // Remove pic and also remove from completedBy if present
                        return { 
                            ...prev, 
                            pic: current.filter(p => p !== pic),
                            completedBy: prev.completedBy.filter(p => p !== pic)
                        };
                    } else {
                        return { ...prev, pic: [...current, pic] };
                    }
                });
            };

            const toggleCompletion = (pic) => {
                if (!isAdmin) return;
                setFormData(prev => {
                    const current = prev.completedBy;
                    if (current.includes(pic)) {
                        return { ...prev, completedBy: current.filter(p => p !== pic) };
                    } else {
                        return { ...prev, completedBy: [...current, pic] };
                    }
                });
            };

            const handleSingleDelete = (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                if(confirm(`Remove only this specific day from the schedule?`)) onDelete(task.id, 'single');
            };

            const handleFullDelete = (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                if(confirm('Delete entire task and all its dates?')) onDelete(task.id, 'all');
            };

            const handleShare = () => {
                const picNames = formData.pic.join(', ');
                const text = `*New Task Assignment* 📅\n\n*Task:* ${formData.title}\n*PIC:* ${picNames}\n*Start:* ${formData.startDate}\n*End:* ${formData.endDate}\n*Status:* ${getTaskStatus(formData)}\n\n${formData.description}`;
                const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            };

            if (!isOpen) return null;

            const isCarried = task?.isCarried;
            // Strict range check for Remove Day button
            const canRemoveDay = task && !isCarried && formData.startDate !== formData.endDate && (date >= formData.startDate && date <= formData.endDate);
            
            const currentStatus = task ? getTaskStatus(formData) : 'future'; 

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200 max-h-[90vh] flex flex-col">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-start shrink-0">
                            <div>
                                <h3 className="text-lg font-bold flex items-center gap-2">{isAdmin ? (task ? 'Edit Task' : 'New Task') : 'Task Details'}</h3>
                                <div className="flex items-center gap-2 text-slate-400 text-xs mt-1">
                                    <span className="flex items-center gap-1"><PlayCircle className="w-3 h-3"/> Start: {formData.startDate}</span>
                                    <span className="text-slate-600">→</span>
                                    <span className="flex items-center gap-1"><Flag className="w-3 h-3"/> End: {formData.endDate}</span>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                {isAdmin && (
                                    <button onClick={handleShare} className="text-slate-400 hover:text-green-400 transition-colors" title="Notify PIC via WhatsApp">
                                        <Share2 className="w-5 h-5" />
                                    </button>
                                )}
                                <button onClick={onClose} className="text-slate-400 hover:text-white"><X className="w-5 h-5" /></button>
                            </div>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4 overflow-y-auto">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Task / Duty</label>
                                <input required disabled={!isAdmin} type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-medium disabled:opacity-70 disabled:bg-slate-100" />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Start Date</label>
                                    <input required disabled={!isAdmin} type="date" value={formData.startDate} onChange={e => setFormData({...formData, startDate: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none disabled:opacity-70 disabled:bg-slate-100" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Completion Date</label>
                                    <input required disabled={!isAdmin} type="date" value={formData.endDate} onChange={e => setFormData({...formData, endDate: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none disabled:opacity-70 disabled:bg-slate-100" />
                                </div>
                            </div>
                            
                            {/* Auto Status Display */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Current Status (Auto)</label>
                                <div className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold capitalize 
                                    ${currentStatus === 'completed' ? 'bg-emerald-100 text-emerald-800' : 
                                      currentStatus === 'future' ? 'bg-indigo-100 text-indigo-800' :
                                      currentStatus === 'overdue' ? 'bg-red-100 text-red-800' : 
                                      'bg-blue-100 text-blue-800'}`}>
                                    {currentStatus}
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">PIC (Assign & Complete)</label>
                                <div className="flex flex-col gap-2">
                                    {Object.keys(PIC_COLORS).filter(p => p !== 'Admin').map(role => {
                                        const isAssigned = formData.pic.includes(role);
                                        const isCompleted = formData.completedBy.includes(role);
                                        
                                        return (
                                            <div key={role} className="flex items-center justify-between p-2 rounded border border-slate-100 hover:bg-slate-50">
                                                <div className="flex items-center gap-3">
                                                    {/* Assignment Toggle */}
                                                    <button
                                                        type="button"
                                                        onClick={() => togglePic(role)}
                                                        disabled={!isAdmin}
                                                        className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${isAssigned ? 'bg-slate-800 border-slate-800 text-white' : 'bg-white border-slate-300'}`}
                                                    >
                                                        {isAssigned && <Check className="w-3 h-3" />}
                                                    </button>
                                                    <span className={`text-sm font-bold ${isAssigned ? 'text-slate-800' : 'text-slate-400'}`}>{role}</span>
                                                </div>

                                                {/* Completion Toggle (Only if Assigned) */}
                                                {isAssigned && (
                                                    <button
                                                        type="button"
                                                        onClick={() => toggleCompletion(role)}
                                                        disabled={!isAdmin}
                                                        className={`px-3 py-1 text-xs rounded-full border transition-all ${isCompleted ? 'bg-emerald-100 text-emerald-800 border-emerald-300' : 'bg-slate-100 text-slate-500 border-slate-200'}`}
                                                    >
                                                        {isCompleted ? 'Completed' : 'Mark Done'}
                                                    </button>
                                                )}
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Details</label>
                                <textarea disabled={!isAdmin} rows={3} value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none disabled:opacity-70 disabled:bg-slate-100"></textarea>
                            </div>
                            
                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <div className="flex justify-between items-center mb-2">
                                     <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Memo Links & Resources</label>
                                </div>
                                {formData.attachments.length === 0 ? <div className="text-center py-4 text-slate-400 text-sm italic">No links added</div> : (
                                    <div className="space-y-2">{formData.attachments.map((file, idx) => (
                                        <div key={idx} className="flex items-center justify-between bg-white p-2 rounded border border-slate-200 shadow-sm">
                                            <div className="flex items-center gap-2 overflow-hidden">
                                                <div className="bg-indigo-100 p-1.5 rounded text-indigo-600"><Link className="w-4 h-4" /></div>
                                                <span className="text-sm truncate font-medium text-slate-700 max-w-[200px]" title={file.name}>{file.name}</span>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <a href={file.url} target="_blank" className="p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded" title="Open Link"><ExternalLink className="w-4 h-4"/></a>
                                                {isAdmin && <button type="button" onClick={() => removeFile(idx)} className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"><X className="w-4 h-4" /></button>}
                                            </div>
                                        </div>
                                    ))}</div>
                                )}
                                {isAdmin && (
                                    <div className="flex gap-2 mt-3 pt-2 border-t border-slate-200">
                                        <input
                                            type="text"
                                            value={tempLink}
                                            onChange={(e) => setTempLink(e.target.value)}
                                            placeholder="Paste memo link here..."
                                            className="flex-1 p-2 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-indigo-500 outline-none"
                                            onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addLink())}
                                        />
                                        <button type="button" onClick={addLink} className="p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors"><Plus className="w-4 h-4" /></button>
                                    </div>
                                )}
                            </div>
                            
                            {isAdmin && (
                                <div className="flex gap-3 pt-4 border-t border-slate-100 mt-4 shrink-0 flex-wrap">
                                    {task ? (
                                        <div className="flex gap-2 w-full">
                                            {/* Specific Day Delete (Only if multi-day and not carried) */}
                                            {canRemoveDay && (
                                                <button 
                                                    type="button" 
                                                    onClick={handleSingleDelete} 
                                                    className="px-3 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg text-xs flex items-center gap-1 font-bold border border-red-100"
                                                    title={`Splits the task to remove ${date}`}
                                                >
                                                    <Trash2 className="w-3 h-3" /> Remove Day ({date.slice(8)})
                                                </button>
                                            )}
                                            
                                            {/* Full Delete */}
                                            <button 
                                                type="button" 
                                                onClick={handleFullDelete} 
                                                className={`px-3 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg text-xs flex items-center gap-1 font-bold ${!canRemoveDay ? 'mr-auto' : ''}`}
                                            >
                                                <Trash2 className="w-3 h-3" /> Delete Task
                                            </button>

                                            <div className="flex-1"></div>
                                            <button type="button" onClick={onClose} className="px-5 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                            <button type="submit" className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-sm">Save</button>
                                        </div>
                                    ) : (
                                        <div className="flex w-full">
                                            <div className="flex-1"></div>
                                            <div className="flex gap-2">
                                                <button type="button" onClick={onClose} className="px-5 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                                <button type="submit" className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-sm">Add Task</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {task && task.timestamp && (
                                <div className="text-[10px] text-slate-400 text-right mt-2 pt-2 border-t border-slate-100">
                                    Last Updated: {new Date(task.timestamp).toLocaleString('en-MY', { hour12: true, dateStyle: 'medium', timeStyle: 'short' })}
                                </div>
                            )}
                        </form>
                    </div>
                </div>
            );
        }

        // --- Init ---
        const root = createRoot(document.getElementById('root'));
        root.render(<PlannerApp />);
    </script>
</body>
</html>
